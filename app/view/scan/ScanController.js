Ext.define('VulnerabilityScannerClient.view.scan.ScanController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.scan-controller',

    reset: function () {
        this.getView().reset();
    },

    submit: function () {
        var form = this.getView();
        var values = form.getValues();
        var url = values.url;
        var server = values.server;
        Ext.Ajax.request({
            url: 'http://192.168.239.128:8080/' + server.toLowerCase() + 'Scan?url=' + url,
            //url: 'http://192.168.186.129:1841/' + server.toLowerCase() + 'Scan?url=' + url,
            method: "GET",
            useDefaultXhrHeader : false,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'HEAD, GET, POST, PUT, PATCH, DELETE',
                'Access-Control-Allow-Headers': '*'
            },
            
            success: function (response, opts) {
                var obj = Ext.decode(response.responseText);
                console.dir(obj);

                var store = Ext.StoreMgr.lookup('vulnerabilities'); 
                store.loadData(obj);

                console.log(store.id);
                msg.hide();
                Ext.Msg.alert('Status', 'Scan done! Go to the dashboard');
            },
    
            failure: function (response, opts) {
                console.log('server-side failure with status code ' + response.status);
                msg.hide();
                Ext.Msg.alert('Status', 'Error! Something is incorrect');
            }
        });
        var msg = Ext.MessageBox.show({
            msg : 'Scanning target, please wait...',
            progressText : 'Scanning...',
            width : 300,
            wait : true,
            waitConfig : 
            {
                duration : 1000000,
                increment : 5,
                text : 'Scanning...',
                scope : this,
                fn : function(){
                    Ext.MessageBox.hide();
                    Ext.Msg.alert('Status', 'Scan done!');
                }
            }
        });
    }
});
